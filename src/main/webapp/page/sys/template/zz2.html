<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>#(model)</title>
<script src="/layuiadmin/main.js"></script>
<script src="/layuiadmin/vxe-render/index.js" type="module"></script>
<style type="text/css">
</style>
</head>
<body>
	<div id="app">
		<el-container>
	    	<el-main>
	  			<el-card class="box-card">
	  				<div ref="banner">
	  					<el-row>
		  					<el-form :inline="true" size="mini"class="demo-form-inline">
							  <el-form-item v-for="(item,index) in parent_columns" v-if="item.is_query" :label="item.cn">
							    <el-input v-if="item.type == 'input'" v-model="queryForm[item.en]"></el-input>
							    <el-select v-if="item.type=='select' || item.type=='radio'" v-model="queryForm[item.en]" filterable placeholder="请选择">
								    <el-option
								      label="全部"
								      value=""
								      selected>
								    </el-option>
								    <el-option
								      v-for="selectItem in parent_selectList[index]"
								      :key="selectItem.id"
								      :label="selectItem.label"
								      :value="selectItem.value">
								    </el-option>
								</el-select>
								<el-date-picker
									v-if="item.type=='date'"
							        v-model="queryForm[item.en]"
							        type="daterange"
							        value-format="yyyy-MM-dd"
							        range-separator="至"
							        start-placeholder="开始日期"
							        end-placeholder="结束日期">
							    </el-date-picker>
							    <el-date-picker
									v-if="item.type=='datetime'"
							        v-model="queryForm[item.en]"
							        type="datetimerange"
							        value-format="yyyy-MM-dd HH:mm:ss"
							        range-separator="至"
							        start-placeholder="开始时间"
							        end-placeholder="结束时间">
							    </el-date-picker>
							  </el-form-item>
							  <el-form-item>
							    <el-button type="primary" @click="query">查询</el-button>
							  </el-form-item>
							</el-form>
						</el-row>
					</div>
					<div :style="'height:'+split_height+'px'">
				        <Split v-model="split" mode="vertical" on-moving="split_change">
				            <div slot="top" class="demo-split-pane">
				                <el-row>
					  			  <template>
								    <vxe-grid :data="parent_data"
								    @current-change="parent_change" 
								    highlight-current-row 
								    :export-config="{remote:true,exportMethod:this.parent_exportDataEvent}"
								    ref="xTable" :border="true" stripe size="mini" :height="parent_height"
								    :toolbar="tableToolbar"
								    resizable
								    highlight-hover-row
			          				highlight-current-row
								    :edit-config="{trigger: 'dblclick', mode: 'cell'}"
								    :checkbox-config="{labelField: '', highlight: true, range: true,change:'checkEvent'}"
								    @checkbox-change="checkEvent"
								    @checkbox-all="checkEvent"
								    @checkbox-range="checkEvent"
								    :pager-config="p_tablePage"
								    @page-change="handleCurrentChange"
								    @edit-closed="parentEditClosedEvent" style="width: 100%">
								    <template v-slot:toolbar_buttons>
							            <el-button v-if="p_data_object.is_add" type="primary" size="mini" @click="parentAddInit" style="margin-left:10px">新增</el-button>
							            <el-button v-for="item in p_headButtons" v-if="item.is_show&&headButtonAuth(item)" size="mini" :type="item.color" :icon="item.icon" @click="item.type==1?headButtonConfirmClick(item):headButtonComboboxClick(item)">{{item.name}}</el-button>
							          </template>
							          <vxe-table-column type="checkbox" title="" width="60"></vxe-table-column>
								      <vxe-table-column v-if="item.is_show" v-for="(item,index) in parent_columns" :key="item.id"
								      	:field="item.en"
								      	:title="item.cn"
								      	:width="item.width"
								      	:sortable="item.is_order"
								      	show-overflow
								      	show-header-overflow
								      	v-bind="item.type!='file'?(item.is_update&&p_data_object.is_update?
									      	(item.type=='input'?{'edit-render':{name: 'input'}}:
									      	 item.type=='select'||item.type=='radio'?{'edit-render':{name: '$select', options: parent_selectList[index], optionProps: {value: 'value', label: 'label'}}}:
									      	 item.type=='switch'?{'cell-render':{name: '$switch',events:{change:parentEditClosedEvent}}}:
									      	 item.type=='date'?{'edit-render':{name: '$input', props: {type: 'date'}}}:
									      	 item.type=='datetime'?{'edit-render':{name: '$input', props: {type: 'datetime'}}}:''):
									      	 
											 item.type=='select'||item.type=='radio'?{'cell-render':{name:'cell-select',options: parent_selectList[index]}}:
											 item.type=='switch'?{'cell-render':{name:'cell-switch'}}:'')
											 
											 :item.is_update&&p_data_object.is_update?{'cell-render':{name: '$button',props:{status:'primary',size:'small',content:'查看'},events:{click:parent_fileEdit}}}:
											 {'cell-render':{name: '$button',props:{status:'primary',size:'small',content:'查看'},events:{click:parent_fileScan}}}">
								      </vxe-table-column>
								      <vxe-table-column
									      title="操作"
									      show-overflow
								      	  show-header-overflow
									      :width="p_data_object.handle_width"
									      v-if="p_data_object.is_handle"
									      fixed="right">
									      <template slot-scope="scope">
									      	<vxe-button v-if="s_data_object.is_add" status="primary" @click="sonAddInit(scope.row)">新增子数据</vxe-button>
									      	<el-button v-for="item in p_lineButtons" v-if="item.is_show&&lineButtonAuth(item,scope.row)" size="mini" :type="item.color" :icon="item.icon" @click="item.type==1?lineButtonConfirmClick(scope.row,item):item.type==2?lineButtonComboboxClick(scope.row,item):lineButtonDialogClick(scope.row,item)">{{item.name}}</el-button>
									        <vxe-button status="danger" v-if="p_data_object.is_delete" icon="el-icon-delete" @click="del(scope.row,'#(menu.data_object_id)')" circle></vxe-button>
									      </template>
									  </vxe-table-column>
								    </vxe-grid>
								  </template>
								</el-row>
				            </div>
				            <div slot="bottom" class="demo-split-pane">
				                <el-row>
					  			  <template>
								    <vxe-grid :data="son_data" ref="yTable" :border="true" stripe size="mini" :height="son_height"
								    :export-config="{remote:true,exportMethod:this.son_exportDataEvent}"
								    :toolbar="tableToolbar"
								    highlight-hover-row
			          				highlight-current-row
								    :edit-config="{trigger: 'dblclick', mode: 'cell'}"
								    @edit-closed="sonEditClosedEvent" style="width: 100%"
								    :checkbox-config="{labelField: '', highlight: true, range: true,change:'son_checkEvent'}"
								    @checkbox-change="son_checkEvent"
								    @checkbox-all="son_checkEvent"
								    @checkbox-range="son_checkEvent">
								    <template v-slot:toolbar_buttons>
							            <el-button style="margin-left:10px" v-for="item in s_headButtons" v-if="item.is_show&&headButtonAuth(item)" size="mini" :type="item.color" :icon="item.icon" @click="item.type==1?son_headButtonConfirmClick(item):son_headButtonComboboxClick(item)">{{item.name}}</el-button>
							          </template>
							          <vxe-table-column type="checkbox" title="" width="60"></vxe-table-column>
								      <vxe-table-column v-if="item.is_show" v-for="(item,index) in son_columns" :key="item.id"
								      	:field="item.en" 
								      	:title="item.cn"
								      	:width="item.width"
								      	show-overflow
								      	v-bind="item.type!='file'?(item.is_update&&s_data_object.is_update?
									      	(item.type=='input'?{'edit-render':{name: 'input'}}:
									      	 item.type=='select'||item.type=='radio'?{'edit-render':{name: '$select', options: son_selectList[index], optionProps: {value: 'value', label: 'label'}}}:
									      	 item.type=='switch'?{'cell-render':{name: '$switch',events:{change:parentEditClosedEvent}}}:
									      	 item.type=='date'?{'edit-render':{name: '$input', props: {type: 'date'}}}:
									      	 item.type=='datetime'?{'edit-render':{name: '$input', props: {type: 'datetime'}}}:''):
									      	 
											 item.type=='select'||item.type=='radio'?{'cell-render':{name:'cell-select',options: son_selectList[index]}}:
											 item.type=='switch'?{'cell-render':{name:'cell-switch'}}:'')
											 
											 :item.is_update&&s_data_object.is_update?{'cell-render':{name: '$button',props:{status:'primary',size:'small',content:'查看'},events:{click:son_fileEdit}}}:
											 {'cell-render':{name: '$button',props:{status:'primary',size:'small',content:'查看'},events:{click:son_fileScan}}}">
								      </vxe-table-column>
								      <vxe-table-column
									      title="操作"
									      show-overflow
									      :width="s_data_object.handle_width"
									      v-if="s_data_object.is_handle"
									      show-overflow
								      	  show-header-overflow
									      fixed="right">
									      <template slot-scope="scope">
									      	<el-button v-for="item in s_lineButtons" size="mini" :type="item.color" :icon="item.icon" @click="item.type==1?lineButtonConfirmClick(scope.row,item):item.type==2?lineButtonComboboxClick(scope.row,item):lineButtonDialogClick(scope.row,item)">{{item.name}}</el-button>
									        <vxe-button status="danger" v-if="s_data_object.is_delete" icon="el-icon-delete" @click="del(scope.row,'#(menu.son_data_object_id)')" circle></vxe-button>
									      </template>
									  </vxe-table-column>
								    </vxe-grid>
								  </template>
								</el-row>
				            </div>
				        </Split>
				    </div>
				</el-card>
				
	  			<!-- 主表新增dialog -->
	  			<el-dialog title="新增" :before-close="handleClose" :visible.sync="parentDialogVisible" :with-header="true">
				  <el-row :gutter="4">
					  <el-form :rules="parent_rules" ref="parent_form" :model="form" label-width="80px" size="mini">
					    <el-col :span="item.type=='radio'?24:12" v-for="(item,index) in parent_columns">
					  		<el-form-item v-if="item.is_add" :label="item.cn" :prop="item.en" :label-width="formLabelWidth">
						      <el-input v-if="item.type == 'input'" v-model="form[item.en]"></el-input>
						      <el-select v-if="item.type=='select'" v-model="form[item.en]" filterable placeholder="请选择" style="width:100%">
							    <el-option
							      v-for="selectItem in parent_selectList[index]"
							      :key="selectItem.id"
							      :label="selectItem.label"
							      :value="selectItem.value">
							    </el-option>
							  </el-select>
							  <el-radio-group v-if="item.type=='radio'" v-model="form[item.en]">
							    <el-radio v-for="selectItem in parent_selectList[index]" :label="selectItem.value">{{selectItem.label}}</el-radio>
							  </el-radio-group>
							  <el-switch
							  	  v-if="item.type=='switch'"
								  v-model="form[item.en]"
								  active-color="#13ce66"
								  inactive-color="#ff4949">
							  </el-switch>
							  <el-date-picker
									v-if="item.type=='date'"
							        v-model="form[item.en]"
							        type="date"
							        value-format="yyyy-MM-dd"
							        style="width:100%"
							        placeholder="选择日期">
							  </el-date-picker>
							  <el-date-picker
									v-if="item.type=='datetime'"
							        v-model="form[item.en]"
							        type="datetime"
							        value-format="yyyy-MM-dd HH:mm:ss"
							        style="width:100%"
							        placeholder="选择日期">
							  </el-date-picker>
						      <el-upload
						      	  v-if="item.type=='file'"
								  class="upload-demo"
								  ref="upload"
								  action="/common/upload"
								  :data="{column:item.en}"
								  :accept="item.formatter.split('|')[2]"
								  :multiple="false"
								  :on-remove="beforeRemove"
								  :on-success="handleSuccess"
								  :on-exceed="handleExceed"
								  :limit="parseInt(item.formatter.split('|')[1])"
								  :file-list="fileList"
								  :auto-upload="true">
								  <el-button slot="trigger" size="small" type="primary">选取文件</el-button>
								  <!-- <el-button style="margin-left: 10px;" size="small" type="success" @click="submitUpload">上传到服务器</el-button> -->
								  <div slot="tip" class="el-upload__tip">只能上传{{item.formatter.split('|')[2]}}文件</div>
							  </el-upload>
						    </el-form-item>
						  </el-col>
					  </el-form>
				  </el-row>
				  <span slot="footer" class="dialog-footer">
				    <el-button @click="parentDialogVisible = false">取 消</el-button>
				    <el-button type="primary" @click="onSubmit('parent_form')">确 定</el-button>
				  </span>
				</el-dialog>
				<!-- 主表新增dialog -->
				
				<!-- 子表新增dialog -->
				<el-dialog title="新增子数据" :before-close="handleClose" :visible.sync="sonDialogVisible" :with-header="true">
				  <el-row :gutter="4">
					  <el-form :rules="son_rules" ref="sonForm" :model="form" label-width="80px" size="mini">
					  	<el-col :span="item.type=='radio'?24:12" v-for="(item,index) in son_columns">
					  		<el-form-item v-if="item.is_add" :label="item.cn" :prop="item.en" :label-width="formLabelWidth">
						      <el-input v-if="item.type == 'input'" v-model="form[item.en]"></el-input>
						      <el-select v-if="item.type=='select'" v-model="form[item.en]" filterable placeholder="请选择">
							    <el-option
							      v-for="selectItem in son_selectList[index]"
							      :key="selectItem.id"
							      :label="selectItem.label"
							      :value="selectItem.value">
							    </el-option>
							  </el-select>
							  <el-radio-group v-if="item.type=='radio'" v-model="form[item.en]">
							    <el-radio v-for="selectItem in son_selectList[index]" :label="selectItem.value">{{selectItem.label}}</el-radio>
							  </el-radio-group>
							  <el-switch
							  	  v-if="item.type=='switch'"
								  v-model="form[item.en]"
								  active-color="#13ce66"
								  inactive-color="#ff4949">
							  </el-switch>
							  <el-date-picker
									v-if="item.type=='date'"
							        v-model="form[item.en]"
							        type="date"
							        value-format="yyyy-MM-dd"
							        placeholder="选择日期">
							  </el-date-picker>
							  <el-date-picker
									v-if="item.type=='datetime'"
							        v-model="form[item.en]"
							        type="datetime"
							        value-format="yyyy-MM-dd HH:mm:ss"
							        placeholder="选择日期">
							  </el-date-picker>
						      <el-upload
						      	  v-if="item.type=='file'"
								  class="upload-demo"
								  ref="upload"
								  action="/common/upload"
								  :data="{column:item.en}"
								  :accept="item.formatter.split('|')[2]"
								  :multiple="false"
								  :on-remove="beforeRemove"
								  :on-success="handleSuccess"
								  :on-exceed="handleExceed"
								  :limit="parseInt(item.formatter.split('|')[1])"
								  :file-list="fileList"
								  :auto-upload="true">
								  <el-button slot="trigger" size="small" type="primary">选取文件</el-button>
								  <!-- <el-button style="margin-left: 10px;" size="small" type="success" @click="submitUpload">上传到服务器</el-button> -->
								  <div slot="tip" class="el-upload__tip">只能上传{{item.formatter.split('|')[2]}}文件</div>
							  </el-upload>
						    </el-form-item>
						  </el-col>
					  </el-form>
					</el-row>
				  <span slot="footer" class="dialog-footer">
				    <el-button @click="sonDialogVisible = false">取 消</el-button>
				    <el-button type="primary" @click="onSubmit('sonForm')">确 定</el-button>
				  </span>
				</el-dialog>
				<!-- 子表新增dialog -->
				
				<!-- 文件列表dialog -->
				<el-dialog title="文件列表" :visible.sync="fileDialogVisible" :with-header="true" width="300px">
					<template v-for="(item,index) in inFileList">
						<el-row style="margin-top:10px" justify="space-between">
							<el-col v-if="file_edit" :span="20">
								<a :href="'#(domin_url)'+item.url" target="_blank">{{item.name}}</a>
							</el-col>
							<el-col :span="4" style="text-align:right">
								<a style="cursor:pointer" @click="delFile(item.id,index)">x</a>
							</el-col>
						</el-row>
					</template>
						<el-row style="margin-top:20px">
							<el-upload
								  class="upload-demo"
								  ref="uploadUpdate"
								  action="/common/upload"
								  :multiple="false"
								  :on-remove="beforeRemove"
								  :on-success="handleSuccess"
								  :on-exceed="handleExceed"
								  :file-list="fileList"
								  :auto-upload="true">
								  <el-button v-if="file_edit" slot="trigger" size="small">上传</el-button>
								  <el-button v-if="file_edit" type="primary" size="small" @click="confirmUpload()">保存</el-button>
								  <!-- <el-button style="margin-left: 10px;" size="small" type="success" @click="submitUpload">上传到服务器</el-button> -->
							  </el-upload>
						</el-row>
				</el-dialog>
				<!-- 文件列表dialog -->
				
					<el-dialog :title="buttonDialogTitle" :visible.sync="buttonDialog" :with-header="true" :width="buttonDialogWidth">
						<div :style="{'height':dialogHeight}">
						<iframe ref="dialogFrame" :key="Math.random()" :src="buttonDialogSrc" frameborder="0" width="100%" height="100%"></iframe>
						</div>
					</el-dialog>
	  		</el-main>
		</el-container>
	</div>
<script>
var _config = window.parent._config;
window.dd = window.parent.dd;

window.dd.error(function(err) {
    alert('dd error: ' + JSON.stringify(err));
})
</script>
<script>

window.onresize=function(){  
	this.app.fullHeight = document.documentElement.clientHeight; //窗口高度
}

	  var app = new Vue({
		  el: '#app',
		  data: {
			  split:0.5,
			  user_roles:'#(session.user_roles)',
			  parent_data:[],
			  parent_columns:[],
			  son_data:[],
			  son_columns:[],
			  form:{},
			  queryForm:{},
			  parent:{},
			  parentDialogVisible: false,
			  sonDialogVisible: false,
			  fileDialogVisible:false,
			  fileList:[],
			  inFileList:[],
		      formLabelWidth: '120px',
		      fullHeight: document.documentElement.clientHeight,
		      split_height:0,
		      parent_height:0,
		      son_height:0,
		      exportConfig: {
                  remote: true,
                  exportMethod: this.exportDataEvent
              },
              p_tablePage: {
                  currentPage: 1,
                  pageSize: 20,
                  total: 0,
                  pageSizes: [20, 50, 100, 200, 500],
                  layouts: ['Sizes', 'PrevJump', 'PrevPage', 'Number', 'NextPage', 'NextJump', 'FullJump', 'Total'],
  			      perfect: true
  	          },
  	          tableToolbar: {
                slots: {
                  buttons: 'toolbar_buttons'
                },
                refresh: true,
                export: true,
                print: true,
                zoom: true,
                custom: true,
                perfect:true
              },
              selectRow:{},
              parent_rules:{},
              son_rules:{},
              type:'',
              p_data_object:{},
              p_headButtons:[],
              s_data_object:{},
              s_headButtons:[],
              parent_select_rows:[],
              son_select_rows:[],
              buttonDialog:false,
              buttonDialogTitle:'',
           	  buttonDialogWidth:'',
              buttonDialogSrc:'',
           	  dialogRow:{},
           	  dialogHeight:'',
           	  file_edit:false,
		  },
		  created: function () {
			  this.getParentColumns();
			  this.getSonColumns();
		  },
		  watch:{
			  fullHeight:function(){
				  this.split_height=this.fullHeight-85-this.$refs.banner.offsetHeight;
			      this.parent_height=this.split_height*this.split;
			      this.son_height=this.split_height*(1-this.split);
			  },
			  parent_columns:function(val,oldval){
				  this.$nextTick(()=>{ // 页面渲染完成后的回调
					  this.getParentData();
					  this.split_height=this.fullHeight-85-this.$refs.banner.offsetHeight;
				      this.parent_height=this.split_height*this.split;
				      this.son_height=this.split_height*(1-this.split);
				  });
			  },
			  split:function(){
				  this.split_height=this.fullHeight-85-this.$refs.banner.offsetHeight;
			      this.parent_height=this.split_height*this.split;
			      this.son_height=this.split_height*(1-this.split);
			  }
		  },
		  methods: {
			  formChange(value,en,type){
				var a = value;
				if(type=='checkbox'){
					value = "";
					for(var i=0;i<a.length;i++){
						value += a[i]+",";
					}
					value = value.substring(0,value.length-1);
				}
				this.$set(this.formData, en, value);
			  },
			  queryFormChange(value,en){
				this.$set(this.queryForm, en, value);
			  },
			  getParentColumns: function (event) {
				  var _this = this;
				  axios({
			    		method:"post",
			    		url:"/zz/getColumns",
			    		params:{object_id:'#(menu.data_object_id)'}
		    		}).then((res)=>{
				    	if(res.status==200){
					    	console.log(res.data);
				    		_this.parent_columns = res.data.list;
				    		_this.parent_selectList = res.data.selectMap;
				    		_this.parent_rules = res.data.validator;
				    		_this.p_headButtons = res.data.headButtons;
				    		_this.p_lineButtons = res.data.lineButtons;
				    		_this.p_data_object = res.data.data_object;
					  	}else{
					  		this.$message.error('网络请求失败');
					  	}
		    		})  
			  },
			  getSonColumns: function (event) {
				  var _this = this;
				  axios({
			    		method:"post",
			    		url:"/zz/getColumns",
			    		params:{object_id:'#(menu.son_data_object_id)'}
		    		}).then((res)=>{
				    	if(res.status==200){
				    		_this.son_columns = res.data.list;
				    		_this.son_selectList = res.data.selectMap;
				    		_this.son_rules = res.data.validator;
				    		_this.s_headButtons = res.data.headButtons;
				    		_this.s_lineButtons = res.data.lineButtons;
				    		_this.s_data_object = res.data.data_object;
					  	}else{
					  		this.$message.error('网络请求失败');
					  	}
		    		})  
			  },
			  getParentData: function (event) {
				  var _this = this;
				  axios({
			    		method:"post",
			    		url:"/zz/getData",
			    		params:{object_id:'#(menu.data_object_id)',currentPage:_this.p_tablePage.currentPage,pageSize:_this.p_tablePage.pageSize}
		    		}).then((res)=>{
				    	if(res.status==200){
				    		if(res.data.state=="fail"){
					    		this.$message.error(res.data.msg);
						    }else{
					    		_this.parent_data = res.data.list;
					    		_this.p_tablePage.total = res.data.totalResult;
						    }
					  	}else{
					  		this.$message.error('网络请求失败');
					  	}
		    		})
			  },
			  query(){
				  var _this = this;
				  axios({
			    		method:"post",
			    		url:"/zz/getData",
			    		params:{object_id:'#(menu.data_object_id)',queryForm:_this.queryForm,currentPage:_this.p_tablePage.currentPage,pageSize:_this.p_tablePage.pageSize}
		    		}).then((res)=>{
				    	if(res.status==200){
				    		_this.parent_data = res.data.list;
				    		_this.p_tablePage.total = res.data.totalResult;
					  	}else{
					  		this.$message.error('网络请求失败');
					  	}
		    		})
			  },
			  handleCurrentChange:function({ currentPage, pageSize }){
				  this.p_tablePage.currentPage = currentPage
	              this.p_tablePage.pageSize = pageSize
	              this.getParentData();
			  },
			  parentAddInit:function(){
		    	this.form = {};
		    	this.fileList = [];
		    	this.type = "parent";
		    	this.parentDialogVisible = true;
			  },
			  sonAddInit:function(row){
		    	this.form = {};
		    	this.fileList = [];
		    	this.type = "son";
		    	this.parent = row;
		    	this.sonDialogVisible = true;
			  },
		      onSubmit:function(formName){
		    	  var _this = this;
		    	  this.$refs[formName].validate((valid) => {
		              if (valid) {
				    	var object_id = "";
				    	if(_this.type=="parent"){
				    		object_id="#(menu.data_object_id)";
					    }else{
					    	object_id="#(menu.son_data_object_id)";
						}
				    	axios({
				    		method:"post",
				    		url:"/zz/new_",
				    		params:{object_id:object_id,form:_this.form,fileList:_this.fileList,type:_this.type,parent:_this.parent,menu_id:"#(menu.id)"}
			    		}).then((res)=>{
					    	if(res.status==200){
					    		if(res.data.state=="ok"){
						    		_this.$message({
					    		          message: res.data.msg,
					    		          type: 'success'
					    		        });
						    		_this.parentDialogVisible = false;
						    		_this.sonDialogVisible = false;
						    		_this.query();
							    }else{
							    	this.$message.error(res.data.error);
								}
						  	}else{
						  		this.$message.error('网络请求失败');
						  	}
			    		})
		              }
		    	  })
		      },
		      //cell编辑
			  parentEditClosedEvent ({ row, column }, event) {
				  var _this = this;
				  axios({
			    		method:"post",
			    		url:"/zz/edit",
			    		params:{object_id:'#(menu.data_object_id)',row:row,column:column.property}
		    		}).then((res)=>{
				    	if(res.status==200){
					    	if(res.data.state=="ok"){
					    		_this.$message({
				    		          message: res.data.msg,
				    		          type: 'success'
				    		        });
						    }else{
						    	this.$message.error(res.data.msg);
							}
					  	}else{
					  		this.$message.error('网络请求失败');
					  	}
		    		})
	          },
	          sonEditClosedEvent ({ row, column }, event) {
				  var _this = this;
				  axios({
			    		method:"post",
			    		url:"/zz/edit",
			    		params:{object_id:'#(menu.son_data_object_id)',row:row,column:column.property}
		    		}).then((res)=>{
				    	if(res.status==200){
					    	if(res.data.state=="ok"){
					    		_this.$message({
				    		          message: res.data.msg,
				    		          type: 'success'
				    		        });
						    }else{
						    	this.$message.error(res.data.error.message);
							}
					  	}else{
					  		this.$message.error('网络请求失败');
					  	}
		    		})
	          },
		      del:function(row,id){
		    	var _this = this;
		    	this.$confirm('确定要删除吗？', '提示', {
		            confirmButtonText: '确定',
		            cancelButtonText: '取消',
		            type: 'warning'
		          }).then(() => {
		        	  axios({
				    		method:"post",
				    		url:"/zz/del",
				    		params:{object_id:id,id:row.id}
			    		}).then((res)=>{
					    	if(res.status==200){
					    		if(res.data.state=="ok"){
						    		_this.$message({
					    		          message: res.data.msg,
					    		          type: 'success'
					    		        });
						    		_this.$refs.xTable.remove(row);
						    		_this.$refs.yTable.remove(row);
							    }else{
							    	this.$message.error(res.data.error.message);
								}
						  	}else{
						  		this.$message.error('网络请求失败');
						  	}
			    		})
		          }).catch(() => {
		            this.$message({
		              type: 'info',
		              message: '已取消删除'
		            });          
		          });
		      },
		      parent_change({row}){
		    	  var _this = this;
		    	  _this.parent_row = row;
		    	  _this.son_select_rows = [];
				  axios({
			    		method:"post",
			    		url:"/zz/getSonData",
			    		params:{menu_id:'#(menu.id)',row:row}
		    		}).then((res)=>{
				    	if(res.status==200){
				    		if(res.data.state=="fail"){
					    		this.$message.error(res.data.msg);
						    }else{
				    			_this.son_data = res.data.list;
						    }
					  	}else{
					  		this.$message.error('网络请求失败');
					  	}
		    		})
			  },
		      handleClose(done) {
		        this.$confirm('确认关闭？')
		          .then(_ => {
		            done();
		          })
		          .catch(_ => {});
	          },
		      beforeRemove(file, fileList) {
		      		this.fileList = fileList;
		      },
		      handleSuccess(res,file,fileList){
		        	this.fileList = fileList;
		      },
		      handleExceed(file, fileList){
		    	  this.$message({
		              type: 'error',
		              message: '超出文件个数限制'
		          });
		      },
		      parent_exportDataEvent:function({ options }) {
		    	  var _this = this;
		              const body = {
		                filename: options.filename,
		                sheetName: options.sheetName,
		                isHeader: options.isHeader,
		                original: options.original,
		                mode: options.mode,
		                ids: options.mode === 'selected' ? options.data.map(item => item.id) : [],
		                fields: options.columns.map(column => {
		                  return {
		                    field: column.property,
		                    title: column.title
		                  }
		                })
		              }
		              // 开始服务端导出
					  return axios({
				    		method:"post",
				    		url:"/common/export",
				    		params:{body:body,
				    			queryForm:_this.queryForm,
				    			object_id:'#(menu.data_object_id)'}
			    		}).then(res=>{
					    	if(res.status==200){
					    		location.href = '#(domin_url)'+res.data.url
						  	}else{
						  		this.$message.error('网络请求失败');
						  	}
			    		})
	          },
	          son_exportDataEvent:function({ options }) {
		    	  var _this = this;
		              const body = {
		                filename: options.filename,
		                sheetName: options.sheetName,
		                isHeader: options.isHeader,
		                original: options.original,
		                mode: options.mode,
		                ids: options.mode === 'selected' ? options.data.map(item => item.id) : [],
		                fields: options.columns.map(column => {
		                  return {
		                    field: column.property,
		                    title: column.title
		                  }
		                })
		              }
		              // 开始服务端导出
					  return axios({
				    		method:"post",
				    		url:"/common/export",
				    		params:{body:body,
				    			object_id:'#(menu.son_data_object_id)',
				    			parent_id_field:'#(menu.parent_id_field)',
				    			son_id_field:'#(menu.son_id_field)',
				    			parent_row:_this.parent_row}
			    		}).then(res=>{
					    	if(res.status==200){
					    		location.href = '#(domin_url)'+res.data.url
						  	}else{
						  		this.$message.error('网络请求失败');
						  	}
			    		})
	          },
		      parent_fileScan({row,column}){
		    	  var _this = this;
		    	  _this.type = "parent";
		    	  _this.fileList = [];
		    	  _this.selectRow = row;
		    	  _this.file_column = column.property;
		    	  axios({
			    		method:"post",
			    		url:"/common/getFileList",
			    		params:{row:row,column:_this.file_column}
		    		}).then((res)=>{
				    	if(res.status==200){
					    	_this.inFileList = res.data;
					    	_this.fileDialogVisible = true;
					  	}else{
					  		this.$message.error('网络请求失败');
					  	}
		    		})
			  },
			  son_fileScan({row,column}){
		    	  var _this = this;
		    	  _this.type = "son";
		    	  _this.fileList = [];
		    	  _this.selectRow = row;
		    	  _this.file_column = column.property;
		    	  axios({
			    		method:"post",
			    		url:"/common/getFileList",
			    		params:{row:row,column:_this.file_column}
		    		}).then((res)=>{
				    	if(res.status==200){
					    	_this.inFileList = res.data;
					    	_this.fileDialogVisible = true;
					  	}else{
					  		this.$message.error('网络请求失败');
					  	}
		    		})
			  },
			  delFile(id,index){
				  var _this = this;
				  if(_this.type=="parent"){
			    		object_id="#(menu.data_object_id)";
				    }else{
				    	object_id="#(menu.son_data_object_id)";
					}
				  _this.$confirm('此操作将永久删除该文件, 是否继续?', '提示', {
			          confirmButtonText: '确定',
			          cancelButtonText: '取消',
			          type: 'warning'
			        }).then(() => {
			        	axios({
				    		method:"post",
				    		url:"/common/delFile",
				    		params:{row:_this.selectRow,column:_this.file_column,file_id:id,object_id:object_id}
			    		}).then((res)=>{
					    	if(res.status==200){
						    	if(res.data.state=="ok"){
						    		_this.$message({
					    		          message: res.data.msg,
					    		          type: 'success'
					    		        });
				    		        _this.inFileList.splice(index,1)
							    }else{
							    	this.$message.error(res.data.msg);
								}
						  	}else{
						  		this.$message.error('网络请求失败');
						  	}
			    		})
			        })
			  },
			  confirmUpload(){
				var _this = this;
				var object_id = "";
		    	if(_this.type=="parent"){
		    		object_id="#(menu.data_object_id)";
			    }else{
			    	object_id="#(menu.son_data_object_id)";
				}
				axios({
  		    		method:"post",
  		    		url:"/common/confirmUpload",
  		    		params:{row:_this.selectRow,fileList:_this.fileList,object_id:object_id,column:_this.file_column}
  	    		}).then((res)=>{
  		    		console.log(res);
  			    	if(res.status==200){
  			    		if(res.data.state=="ok"){
  				    		_this.$message({
  			    		          message: res.data.msg,
  			    		          type: 'success'
  			    		    });
  			    		    for(var i=0;i<res.data.respFileList.length;i++){
  			    		    	_this.inFileList.push({
  	  			    		    	id:res.data.respFileList[i].id,
  	  				    			name: res.data.respFileList[i].name,
  	  				    			url:res.data.respFileList[i].url
  	  				    		});
  	  			    		}
  	  			    		_this.$refs.uploadUpdate.clearFiles();
  					    }else{
  					    	this.$message.error(res.data.msg);
  						}
  				  	}else{
  				  		this.$message.error('网络请求失败');
  				  	}
  	    		})
			  },
			  lineButtonConfirmClick(row,button){
				  var _this = this;
				  _this.$confirm(button.tip, '提示', {
			          confirmButtonText: '确定',
			          cancelButtonText: '取消',
			          type: 'warning'
			        }).then(() => {
			        	axios({
				    		method:"post",
				    		url:button.action,
				    		params:row
			    		}).then((res)=>{
					    	if(res.status==200){
						    	if(res.data.state=="ok"){
						    		_this.$message({
				    		          message: res.data.msg,
				    		          type: 'success'
				    		        });
							    }else{
							    	this.$message.error(res.data.msg);
								}
						  	}else{
						  		this.$message.error('网络请求失败');
						  	}
			    		})
			        })
			  },
			  lineButtonComboboxClick(row,button){
				  var _this = this;
				  this.$prompt(button.tip, '提示', {
			          confirmButtonText: '确定',
			          cancelButtonText: '取消',
			        }).then(({ value }) => {
				        row.comboValue = value;
			        	axios({
				    		method:"post",
				    		url:button.action,
				    		params:row
			    		}).then((res)=>{
					    	if(res.status==200){
						    	if(res.data.state=="ok"){
						    		_this.$message({
				    		          message: res.data.msg,
				    		          type: 'success'
				    		        });
							    }else{
							    	this.$message.error(res.data.msg);
								}
						  	}else{
						  		this.$message.error('网络请求失败');
						  	}
			    		})
			        })
			  },
			  lineButtonDialogClick(row,button){
				    var _this = this;
		    		_this.buttonDialog = true;
			    	_this.buttonDialogSrc = button.dialog_src;
			    	_this.buttonDialogTitle = button.dialog_title;
			    	_this.buttonDialogWidth = button.dialog_width;
			    	_this.dialogRow = row;
			  },
			  checkEvent ({ checked, records }) {
				  this.parent_select_rows = records
              },
              son_checkEvent ({ checked, records }) {
				  this.son_select_rows = records
              },
              headButtonConfirmClick(button){
				  var _this = this;
				  if(_this.parent_select_rows.length>0){
					  _this.$confirm(button.tip, '提示', {
				          confirmButtonText: '确定',
				          cancelButtonText: '取消',
				          type: 'warning'
				        }).then(() => {
				        	axios({
					    		method:"post",
					    		url:button.action,
					    		params:{rows:_this.parent_select_rows}
				    		}).then((res)=>{
						    	if(res.status==200){
							    	if(res.data.state=="ok"){
							    		_this.$message({
					    		          message: res.data.msg,
					    		          type: 'success'
					    		        });
								    }else{
								    	this.$message.error(res.data.msg);
									}
							  	}else{
							  		this.$message.error('网络请求失败');
							  	}
				    		})
				        })
				  }else{
					  this.$message({
				          message: '请至少选择一行数据进行操作',
				          type: 'warning'
				        });
				  }
			  },
			  headButtonComboboxClick(button){
				  var _this = this;
				  if(_this.parent_select_rows.length>0){
					  _this.$prompt(button.tip, '提示', {
				          confirmButtonText: '确定',
				          cancelButtonText: '取消',
				        }).then(({ value }) => {
				        	axios({
					    		method:"post",
					    		url:button.action,
					    		params:{comboValue:value,rows:_this.parent_select_rows}
				    		}).then((res)=>{
						    	if(res.status==200){
							    	if(res.data.state=="ok"){
							    		_this.$message({
					    		          message: res.data.msg,
					    		          type: 'success'
					    		        });
								    }else{
								    	this.$message.error(res.data.msg);
									}
							  	}else{
							  		this.$message.error('网络请求失败');
							  	}
				    		})
				        })
					}else{
						this.$message({
					          message: '请至少选择一行数据进行操作',
					          type: 'warning'
					        });
					}
			  },
			  son_headButtonConfirmClick(button){
				  var _this = this;
				  if(_this.son_select_rows.length>0){
					  _this.$confirm(button.tip, '提示', {
				          confirmButtonText: '确定',
				          cancelButtonText: '取消',
				          type: 'warning'
				        }).then(() => {
				        	axios({
					    		method:"post",
					    		url:button.action,
					    		params:{rows:_this.son_select_rows}
				    		}).then((res)=>{
						    	if(res.status==200){
							    	if(res.data.state=="ok"){
							    		_this.$message({
					    		          message: res.data.msg,
					    		          type: 'success'
					    		        });
								    }else{
								    	this.$message.error(res.data.msg);
									}
							  	}else{
							  		this.$message.error('网络请求失败');
							  	}
				    		})
				        })
				  }else{
					  this.$message({
				          message: '请至少选择一行数据进行操作',
				          type: 'warning'
				        });
				  }
			  },
			  son_headButtonComboboxClick(button){
				  var _this = this;
				  if(_this.son_select_rows.length>0){
					  _this.$prompt(button.tip, '提示', {
				          confirmButtonText: '确定',
				          cancelButtonText: '取消',
				        }).then(({ value }) => {
				        	axios({
					    		method:"post",
					    		url:button.action,
					    		params:{comboValue:value,rows:_this.son_select_rows}
				    		}).then((res)=>{
						    	if(res.status==200){
							    	if(res.data.state=="ok"){
							    		_this.$message({
					    		          message: res.data.msg,
					    		          type: 'success'
					    		        });
								    }else{
								    	this.$message.error(res.data.msg);
									}
							  	}else{
							  		this.$message.error('网络请求失败');
							  	}
				    		})
				        })
					}else{
						this.$message({
					          message: '请至少选择一行数据进行操作',
					          type: 'warning'
					        });
					}
			  },
			  parent_fileEdit({row,column}){
		    	  var _this = this;
		    	  _this.type = "parent";
		    	  _this.fileList = [];
		    	  _this.selectRow = row;
		    	  _this.file_column = column.property;
		    	  _this.file_edit = true;
		    	  axios({
			    		method:"post",
			    		url:"/common/getFileList",
			    		params:{row:row,column:_this.file_column}
		    		}).then((res)=>{
				    	if(res.status==200){
					    	_this.inFileList = res.data;
					    	_this.fileDialogVisible = true;
					  	}else{
					  		this.$message.error('网络请求失败');
					  	}
		    		})
			  },
              son_fileEdit({row,column}){
		    	  var _this = this;
		    	  _this.type = "son";
		    	  _this.fileList = [];
		    	  _this.selectRow = row;
		    	  _this.file_column = column.property;
		    	  _this.file_edit = true;
		    	  axios({
			    		method:"post",
			    		url:"/common/getFileList",
			    		params:{row:row,column:_this.file_column}
		    		}).then((res)=>{
				    	if(res.status==200){
					    	_this.inFileList = res.data;
					    	_this.fileDialogVisible = true;
					  	}else{
					  		this.$message.error('网络请求失败');
					  	}
		    		})
			  },
			  headButtonAuth:function(item){
                  if(item.auth_role!=null){
					var roles = item.auth_role.split(",");
					for(var i=0;i<roles.length;i++){
						if(this.user_roles.indexOf(roles[i])!=-1){
							return true;
						}
					}
                  }else{
					return true;
                  }
                  return false;
				
              },
              lineButtonAuth:function(item,row){
                  if(item.auth_role!=null){
					var roles = item.auth_role.split(",");
					for(var i=0;i<roles.length;i++){
						if(this.user_roles.indexOf(roles[i])!=-1){
							if(item.auth_row!=null){
								var authrow = JSON.parse(item.auth_row);
								for(var j = 0;j<authrow.length;j++){
									for(let key  in row){
								        if(key == authrow[j].field){
									        var aaa = row[key]+authrow[j].operator+authrow[j].value;
								        	if(!eval(aaa)){
												return false;
									        }
									    }
								    }
								}
							}
							return true;
						}
					}
                  }else{
                	  if(item.auth_row!=null){
							var authrow = JSON.parse(item.auth_row);
							for(var j = 0;j<authrow.length;j++){
								for(let key  in row){
							        if(key == authrow[j].field){
								        var aaa = row[key]+authrow[j].operator+authrow[j].value;
							        	if(!eval(aaa)){
											return false;
								        }
								    }
							    }
							}
						}
					  return true;
                  }
                  return false;
              }
		  }
		})
</script>

</body>
</html>