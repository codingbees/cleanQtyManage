

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>layuiAdmin 角色管理</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <link rel="stylesheet" href="/layuiadmin/layui/css/layui.css" media="all">
  <link rel="stylesheet" href="/layuiadmin/style/admin.css" media="all">
  <script type="text/javascript" src="../../js/jquery.min.js"></script>
</head>
<body>

  <div class="layui-fluid">   
    <div class="layui-card">
      <div class="layui-form layui-card-header layuiadmin-card-header-auto">
      </div>
      <div class="layui-card-body">
        <div style="padding-bottom: 10px;">
          <button class="layui-btn layuiadmin-btn-role" data-type="add">添加</button>
        </div>
      
        <table id="LAY-user-back-role" lay-filter="LAY-user-back-role"></table>
        <script type="text/html" id="buttonTpl">
          
        </script>
        <script type="text/html" id="table-useradmin-admin">
          <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="edit"><i class="layui-icon layui-icon-edit"></i>编辑</a>
		  <a class="layui-btn layui-btn-xs" lay-event="setUser">设置人员</a>
          <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del"><i class="layui-icon layui-icon-delete"></i>删除</a>
        </script>
      </div>
    </div>
  </div>
<script src="http://g.alicdn.com/dingding/dingtalk-jsapi/2.0.57/dingtalk.open.js"></script>
<script>
var _config = window.parent._config;
window.dd = window.parent.dd;

dd.ready(function() {
	//选择责任人
	$("#selectUser").click(function(event){
		
	})
	
})

window.dd.error(function(err) {
    alert('dd error: ' + JSON.stringify(err));
})
</script>
 <script src="/layuiadmin/layui/layui.js"></script>  
  <script>

  layui.config({
    base: '/layuiadmin/' //静态资源所在路径
  }).extend({
    index: 'lib/index' //主入口模块
  }).use(['index', 'useradmin', 'table'], function(){
    var $ = layui.$
    ,form = layui.form
    ,admin = layui.admin
    ,table = layui.table;
    
    table.render({
        elem: '#LAY-user-back-role'
        ,url: '/sys/getRole' //模拟接口
    	,method:'post'
        ,cols: [[
          {field: 'id', width: 80, title: 'ID', sort: true}
          ,{field: 'role_name', title: '角色标识'}
          ,{field: 'role_nick_name', title: '角色名'}
          ,{field: 'role_desc', title: '具体描述'}
          ,{title: '操作', align: 'center', fixed: 'right', toolbar: '#table-useradmin-admin'}
        ]]
        ,text: '对不起，加载出现异常！'
      });
    
    
  	//监听工具条
    table.on('tool(LAY-user-back-role)', function(obj){
      var data = obj.data;
      if(obj.event === 'del'){
        layer.confirm('确定删除此角色？', function(index){
          obj.del();
          layer.close(index);
        });
      }else if(obj.event === 'edit'){
        var data = obj.data;
        layer.open({
          type: 2
          ,title: '编辑角色'
          ,content: '/sys/roleform/'+data.id
          ,area: ['500px', '480px']
          ,btn: ['确定', '取消']
          ,yes: function(index, layero){
            var iframeWindow = window['layui-layer-iframe'+ index]
            ,submit = layero.find('iframe').contents().find("#LAY-user-role-submit");

            //监听提交
            iframeWindow.layui.form.on('submit(LAY-user-role-submit)', function(data){
              var field = data.field; //获取提交的字段
              console.log(field);
              var mymsg1 = layer.msg('正在修改角色信息中，请稍候...', {
    			  icon: 16
    			  ,shade: 0.5
    			  ,time:false
    			});
            admin.req({
  			        url: '/sys/roleUpdate' //实际使用请改成服务端真实接口
  			        ,data: field
  			        ,success:function(rsp){
  				  		if(rsp.code==0){
  				  			layer.msg(rsp.msg, {icon: 1});
  				  			layer.close(index);
  				  			table.reload('LAY-user-back-role'); //数据刷新
  					  	}else{
  					  		layer.close(mymsg1);
  						}
  					}
  			      });
              
            });  
            
            submit.trigger('click');
          }
          ,success: function(layero, index){
          
          }
        })
      }else if(obj.event === "setUser"){
    	  admin.req({
		        url: '/sys/getRoleUsers' //实际使用请改成服务端真实接口
		        ,data: {role_id:obj.data.id}
		        ,success:function(resp){
		        	if(resp.code == 0){
		        		dd.biz.contact.choose({
		    	  		    multiple: true, //是否多选：true多选 false单选； 默认true
		    	  		    users: resp.rspUserArray, //默认选中的用户列表，员工userid；成功回调中应包含该信息
		    	  		    corpId: _config.corpId, //企业id
		    	  		    max: 2000,
		    	  		    onSuccess: function(data) {
		    	  		    	admin.req({
		    	  			        url: '/sys/roleSetUser' //实际使用请改成服务端真实接口
		    	  			        ,data: {users:JSON.stringify(data),role_id:obj.data.id}
		    	  			        ,success:function(rsp){
		    				  			layer.msg(rsp.msg, {icon: 1});
		    	  					}
		    	  			      });
		    	  		    },
		    	  		    onFail : function(err) {}
		      			});
		        	}
				}
		      });
      }
    });
  
    //事件
    var active = {
      add: function(){
        layer.open({
          type: 2
          ,title: '添加新角色'
          ,content: '/sys/roleform/0'
          ,area: ['500px', '480px']
          ,btn: ['确定', '取消']
          ,yes: function(index, layero){
            var iframeWindow = window['layui-layer-iframe'+ index]
            ,submit = layero.find('iframe').contents().find("#LAY-user-role-submit");

            //监听提交
            iframeWindow.layui.form.on('submit(LAY-user-role-submit)', function(data){
              var field = data.field; //获取提交的字段
              admin.req({
                  url: '/sys/roleUpdate' //实际使用请改成服务端真实接口
                  ,data: field
                  ,done: function(res){
                    layer.msg(res.msg, {
                      offset: '15px'
                      ,icon: 1
                      ,time: 1000
                    }, function(){
                  		  table.reload('LAY-user-back-role'); //数据刷新
                            layer.close(index); //关闭弹层
                    });
                  }
                });
            });  
            submit.trigger('click');
          }
        }); 
      }
    }  
    $('.layui-btn.layuiadmin-btn-role').on('click', function(){
      var type = $(this).data('type');
      active[type] ? active[type].call(this) : '';
    });

  });
  </script>
</body>
</html>

